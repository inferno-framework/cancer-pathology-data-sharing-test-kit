## Overview
The Cancer Pathology Data Sharing Report Generation Test Suite validates that clinical systems (Laboratory Information Systems and Electronic Health Records) can create pathology reports that conform to the STU 1.0.1 version of the HL7® FHIR® [Cancer Pathology Data Sharing (CPDS) IG](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/). This suite ensures systems can properly structure and encode pathology data for cancer registry reporting.

## Scope
This test suite validates the creation of standardized pathology reports for cancer registry submission. It verifies that systems can generate [Pathology Cancer Exchange Bundles](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html) that include all required components:
- Patient demographics (US Core Patient)
- Encounter details (US Core Encounter)
- Diagnostic findings (US Pathology Diagnostic Report)
- Specimen information (US Pathology Specimen)
- Service requests and practitioner details

The IG defines other capabilities of clinical systems that are currently out of scope for this suite, including:
- The gathering of report content from other systems, if necessary.
- The transmission of reports to registries.
- The exchange of data between LIS and EHR systems, including service requests and diagnostic reports.

## Test Methodology

To verify that the system under test can produce conformant and complete cancer pathology reports, Inferno asks
the tester to provide as input a set of [Pathology Cancer Exchange Bundles](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html)
generated from the system under test. Inferno will check that each Bundle and the must support entry types
are conformant to the required profile. Additionally, to verify completeness the tests check for a populated example of each
must support element designated must support Bundle entry types as well as the profiles required for those entries.

## Running the tests 

### Quick Start

The minimal amount of information Inferno needs to run these tests includes the following inputs:
- **Cancer Reports**: A comma-Separated list of one or more FHIR Pathology Cancer Exchange Bundles
  in JSON format generated by the system under test.

Testers will need to generate one or more reports using the system they are testing, paste them into
the input in Inferno and run the tests. Inferno will evaluate the reports and provide test results.

### Demonstration

If you would like to try out the tests using example data from the CPDS IG, use the "Demo Report"
preset, which contains the [US Pathology Exchange bundle example](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/Bundle-us-pathology-exchange-bundle-example.json.html)
with the [Service Request - Cancer Pathology example](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/ServiceRequest-cancer-path-example.json.html) added to it so as to cover all required entry types. The demo report should pass all the tests.

## Current Limitations

### Report generation and data access differences

The CPDS STU 1.0.1 IG contains mismatches between the profiles made available through
the [EHR Data Access API](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/CapabilityStatement-central-cancer-registry-reporting-ehr-pathology.html)
and those that need to be included in [cancer pathology reports](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html),
both in terms of:
- **The number of profiles**: The [EHR Capability Statement](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/CapabilityStatement-central-cancer-registry-reporting-ehr-pathology.html)
requires support for US Core STU 5 APIs which can return instances conforming to up to [45 profiles](https://www.hl7.org/fhir/us/core/STU5/profiles-and-extensions.html) while the [Pathology Cancer Exchange Bundle profile](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html)
requires explicit support for only 6 profiles. Strictly speaking, the US Core IG does not require implementing systems to support APIs that
return all US Core profiles. However, the CPDS IG does not provide explicit guidance on which resource types and profiles to support
either in the Capability Statement or through the scope of entries to include in the report Bundle (see the **Extra Bundle entries**
limitation on the report generation suite for details).
- **Which profiles**: The [Pathology Cancer Exchange Bundle profile](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html)
requires entry conformance to specific profiles for which there are no APIs defined in the CPDS [EHR Capability Statement](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/CapabilityStatement-central-cancer-registry-reporting-ehr-pathology.html)
or the referenced [US Core Server CapabilityStatement](https://www.hl7.org/fhir/us/core/STU5/CapabilityStatement-us-core-server.html).
For example, the report requires [US Pathology Specimen profile](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-specimen.html)
but the [EHR Capability Statement](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/CapabilityStatement-central-cancer-registry-reporting-ehr-pathology.html)
does not require support for a Specimen resource API directly the referenced version of US Core ([STU 5](https://www.hl7.org/fhir/us/core/STU5/profiles-and-extensions.html))
does not define a profile or API for the Specimen resource type. Additionally, for resource types for which US Core does define APIs, e.g.,
[DiagnosticReport](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-diagnosticreport-note.html),
CPDS doesn't explicitly indicate the need for EHRs to support the CPDS-specific profile in their APIs,
e.g., for [US Pathology DiagnosticReport](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-diagnostic-report.html).

Currently this report generation suite and the data access suite test the requirements indicated in the
IG, including API support for all US Core Profiles, despite the mismatch and their potential to cause
interoperability issues or extra implementation burden. Future versions of this test suite may update this
approach based on community feedback and IG updates.

### Bundle slicing

The [Pathology Cancer Exchange Bundle profile](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html)
describes the required contents in terms of slices on `Bundle.entry` using specific profiles
as [the discriminator](https://build.fhir.org/profiling.html#discriminator). This means, for example,
that a Bundle with two Patient entries would be valid as long as only one of those Patients
did not conform to the [US Core Patient profile](http://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-patient.html)
specified in the patient slice. That interpretation does not align with other forms of these reports,
such as [NAACCR Volume V](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/background.html#fhir-profiles-to-capture-naaccr-volume-v)
which would require exactly one patient.

These tests check [Pathology Cancer Exchange Bundles](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html) as if the slicing were discriminated by
resource type, meaning that any Patient entries are part of the Patient slice. Since the Patient slice
has a cardinality of exactly 1, a Bundle with multiple Patient entries would be invalid regardless of
which profiles they conform to. Future versions of this test suite may update this approach based on
community feedback and IG updates.

### Extra Bundle entries

This test suite currently only checks for the presence of instances of the six resource types indicated in the
[Pathology Cancer Exchange Bundle(s)](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html) and their conformance to the indicated profiles.
The tests do not check that
- Instances recursively referenced from these instances are also present in the Bundle.
- Recursively referenced instances that are present in the Bundle conform to the profile(s) required
  by the referencing element(s).
- All must support elements for recursively referenced profiles are demonstrated.

For example the [US Core Encounter profile](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-encounter.html)
is referenced from a must support `entry` element slice in the [Pathology Cancer Exchange Bundle(s)](https://hl7.org/fhir/us/cancer-reporting/STU1.0.1/StructureDefinition-us-pathology-exchange-bundle.html)
and the [US Core Encounter profile](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-encounter.html)
requires support for the [US Core Practitioner profile](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-practitioner.html)
on the `participant.individual` element. This test suite does not currently test that in a
Bundle where `participant.individual` is demonstrated referencing a Practitioner that the referenced
instance is also present in the Bundle and that it conforms to the [US Core Practitioner profile](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-practitioner.html). 
Must support elements for the [US Core Practitioner profile](https://hl7.org/fhir/us/core/STU5.0.1/StructureDefinition-us-core-practitioner.html)
also do not need to be demonstrated currently.

The CPDS IG does not explicitly require that the above requirements are met, but they are likely
to be necessary or at least helpful in practical applications of report exchange. Future versions
of this test suite may update this approach based on community feedback and IG updates.

### No API-based Submission

The CPDS IG refers to the MedMorph framework for submission which uses FHIR Messaging. Currently, this test suite
does not support submission of reports using this standards-based approach and instead requires manual provision of
the reports using Inferno inputs. Future versions may include support for FHIR Messaging or other approaches
to submission.
